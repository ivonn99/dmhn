<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Formulario de Pedido</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 1000px;
      margin: 0 auto;
      padding: 20px;
    }
    
    .form-group {
      margin-bottom: 15px;
    }
    
    label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
    }
    
    input, select {
      width: 100%;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
      box-sizing: border-box;
    }
    
    #ruta-reparto, #precio-producto, #monto-total, #monto-pedido-total {
      padding: 8px;
      background-color: #f5f5f5;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-weight: bold;
    }

    textarea {
      width: 100%;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
      box-sizing: border-box;
      resize: vertical;
    }

    button {
      background-color: #007bff;
      color: white;
      padding: 12px 24px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
      font-weight: bold;
      margin-right: 10px;
    }

    button:hover {
      background-color: #0056b3;
    }

    button:disabled {
      background-color: #6c757d;
      cursor: not-allowed;
    }

    #agregar-producto {
      background-color: #28a745;
    }

    #agregar-producto:hover {
      background-color: #218838;
    }

    #previsualizar-pedido {
      background-color: #17a2b8;
    }

    #previsualizar-pedido:hover {
      background-color: #138496;
    }

    #enviar-pedido {
      background-color: #28a745;
    }

    #enviar-pedido:hover {
      background-color: #218838;
    }

    /* Estilos para la tabla */
    .tabla-productos {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
      background-color: white;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .tabla-productos th,
    .tabla-productos td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid #ddd;
    }

    .tabla-productos th {
      background-color: #f8f9fa;
      font-weight: bold;
      color: #495057;
      border-top: 2px solid #007bff;
    }

    .tabla-productos tr:hover {
      background-color: #f5f5f5;
    }

    .tabla-productos .cantidad {
      text-align: center;
      width: 80px;
    }

    .tabla-productos .precio,
    .tabla-productos .monto {
      text-align: right;
      width: 100px;
    }

    .tabla-productos .acciones {
      text-align: center;
      width: 100px;
    }

    .btn-eliminar {
      background-color: #dc3545;
      padding: 6px 12px;
      font-size: 12px;
      margin: 0;
    }

    .btn-eliminar:hover {
      background-color: #c82333;
    }

    .tabla-container {
      border: 1px solid #ddd;
      border-radius: 4px;
      overflow-x: auto;
      max-height: 400px;
      overflow-y: auto;
    }

    .sin-productos {
      text-align: center;
      padding: 40px;
      color: #6c757d;
      font-style: italic;
    }

    /* Modal de previsualización */
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
    }

    .modal-content {
      background-color: white;
      margin: 5% auto;
      padding: 30px;
      border-radius: 8px;
      width: 80%;
      max-width: 800px;
      max-height: 80vh;
      overflow-y: auto;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 2px solid #007bff;
    }

    .modal-header h2 {
      margin: 0;
      color: #007bff;
    }

    .close {
      color: #aaa;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
      line-height: 1;
    }

    .close:hover {
      color: #000;
    }

    .resumen-section {
      margin-bottom: 25px;
      padding: 15px;
      border: 1px solid #e9ecef;
      border-radius: 6px;
      background-color: #f8f9fa;
    }

    .resumen-section h3 {
      margin-top: 0;
      margin-bottom: 15px;
      color: #495057;
      border-bottom: 1px solid #dee2e6;
      padding-bottom: 8px;
    }

    .resumen-field {
      margin-bottom: 8px;
    }

    .resumen-field strong {
      color: #495057;
      display: inline-block;
      width: 120px;
    }

    .total-final {
      font-size: 1.2em;
      font-weight: bold;
      color: #28a745;
      text-align: right;
      margin-top: 15px;
      padding: 10px;
      background-color: #d4edda;
      border-radius: 4px;
    }

    .modal-buttons {
      text-align: right;
      margin-top: 30px;
      padding-top: 20px;
      border-top: 1px solid #dee2e6;
    }

    .modal-buttons button {
      margin-left: 10px;
    }

    .mensaje-exito {
      background-color: #d4edda;
      color: #155724;
      padding: 15px;
      border-radius: 4px;
      margin-bottom: 20px;
      border: 1px solid #c3e6cb;
      display: none;
    }

    .mensaje-error {
      background-color: #f8d7da;
      color: #721c24;
      padding: 15px;
      border-radius: 4px;
      margin-bottom: 20px;
      border: 1px solid #f5c6cb;
      display: none;
    }
  </style>
</head>
<body>

  <!-- Mensajes de estado -->
  <div id="mensaje-exito" class="mensaje-exito"></div>
  <div id="mensaje-error" class="mensaje-error"></div>

  <h2>Formulario de Pedido</h2>

  <!-- Sección de Vendedor -->
  <div class="form-group">
    <label for="buscador">Buscar Vendedor:</label>
    <input type="text" id="buscador" placeholder="Buscar vendedor..." />
  </div>

  <div class="form-group">
    <label for="vendedor">Vendedor:</label>
    <select id="vendedor">
      <option disabled selected>Selecciona un vendedor</option>
    </select>
  </div>

  <!-- Sección de Cliente -->
  <div class="form-group">
    <label for="buscador-cliente">Buscar Cliente:</label>
    <input type="text" id="buscador-cliente" placeholder="Buscar cliente..." />
  </div>

  <div class="form-group">
    <label for="cliente">Cliente:</label>
    <select id="cliente">
      <option disabled selected>Selecciona un cliente</option>
    </select>
  </div>

  <!-- Mostrar Ruta de Reparto -->
  <div class="form-group">
    <label for="ruta-reparto">Ruta de Reparto:</label>
    <div id="ruta-reparto">---</div>
  </div>

  <!-- Sección de Zona de Entrega -->
  <div class="form-group">
    <label for="zona-entrega">Zona de Entrega:</label>
    <select id="zona-entrega">
      <option disabled selected>Selecciona una zona de entrega</option>
    </select>
  </div>

  <!-- Otro Destino -->
  <div class="form-group">
    <label for="otro-destino">Otro Destino (opcional):</label>
    <input type="text" id="otro-destino" placeholder="Dirección alternativa" />
  </div>

  <!-- Sección de Productos -->
  <div class="form-group">
    <label for="buscador-producto">Buscar Producto:</label>
    <input type="text" id="buscador-producto" placeholder="Buscar producto..." />
  </div>

  <div class="form-group">
    <label for="producto">Producto:</label>
    <select id="producto">
      <option disabled selected>Selecciona un producto</option>
    </select>
  </div>

  <!-- Precio del producto seleccionado -->
  <div class="form-group">
    <label for="precio-producto">Precio del Producto:</label>
    <div id="precio-producto">$0.00</div>
  </div>

  <!-- Cantidad -->
  <div class="form-group">
    <label for="cantidad">Cantidad:</label>
    <input type="number" id="cantidad" min="1" step="0.1" placeholder="Cantidad" />
  </div>

  <!-- Precio personalizado (opcional) -->
  <div class="form-group">
    <label for="precio-custom">Precio Personalizado (opcional):</label>
    <input type="number" id="precio-custom" step="0.01" placeholder="Dejar vacío para usar precio por defecto" />
  </div>

  <!-- Monto total -->
  <div class="form-group">
    <label for="monto-total">Monto Total:</label>
    <div id="monto-total">$0.00</div>
  </div>

  <!-- Botón para agregar producto a la lista -->
  <div class="form-group">
    <button id="agregar-producto" type="button">Agregar Producto</button>
  </div>

  <!-- Tabla de productos agregados -->
  <div class="form-group">
    <h3>Productos en el Pedido:</h3>
    <div class="tabla-container">
      <table class="tabla-productos" id="tabla-productos">
        <thead>
          <tr>
            <th class="cantidad">Cantidad</th>
            <th>Producto</th>
            <th class="precio">Precio</th>
            <th class="monto">Monto</th>
            <th class="acciones">Acción</th>
          </tr>
        </thead>
        <tbody id="tbody-productos">
          <tr>
            <td colspan="5" class="sin-productos">No hay productos agregados</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- Monto total del pedido completo -->
  <div class="form-group">
    <label for="monto-pedido-total">Monto Total del Pedido:</label>
    <div id="monto-pedido-total">$0.00</div>
  </div>

  <!-- Campos adicionales -->
  <div class="form-group">
    <label for="oferta">Oferta (opcional):</label>
    <input type="text" id="oferta" placeholder="Descripción de oferta" />
  </div>

  <div class="form-group">
    <label for="comentarios">Comentarios (opcional):</label>
    <textarea id="comentarios" rows="3" placeholder="Comentarios adicionales"></textarea>
  </div>

  <!-- Botón para previsualizar pedido -->
  <div class="form-group">
    <button id="previsualizar-pedido" type="button">Previsualizar Pedido</button>
  </div>

  <!-- Modal de previsualización -->
  <div id="modal-preview" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Resumen del Pedido</h2>
        <span class="close">&times;</span>
      </div>
      
      <div id="contenido-preview">
        <!-- El contenido se generará dinámicamente -->
      </div>
      
      <div class="modal-buttons">
        <button type="button" onclick="cerrarModal()">Cancelar</button>
        <button id="enviar-pedido" type="button">Enviar Pedido</button>
      </div>
    </div>
  </div>

  <script type="module">
    const SUPABASE_URL = 'https://gedrcazwwzarxjxbtgnd.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdlZHJjYXp3d3phcnhqeGJ0Z25kIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDk3NDQxOTAsImV4cCI6MjA2NTMyMDE5MH0.aQwEviYlvjyYZVIjbJUDM2YgEDOKTaNK65nno4iVtiY';

    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // Variables globales
    let vendedoresData = [];
    let clientesMostrados = [];
    let productosData = [];
    let zonasEntregaData = [];
    let productosEnPedido = [];

    // Función debounce para optimizar búsquedas
    function debounce(fn, delay) {
      let timeoutId;
      return function(...args) {
        clearTimeout(timeoutId);
        timeoutId = setTimeout(() => fn.apply(this, args), delay);
      };
    }

    // Funciones de utilidad para mensajes
    function mostrarMensajeExito(mensaje) {
      const elemento = document.getElementById('mensaje-exito');
      elemento.textContent = mensaje;
      elemento.style.display = 'block';
      document.getElementById('mensaje-error').style.display = 'none';
      window.scrollTo({ top: 0, behavior: 'smooth' });
      setTimeout(() => {
        elemento.style.display = 'none';
      }, 5000);
    }

    function mostrarMensajeError(mensaje) {
      const elemento = document.getElementById('mensaje-error');
      elemento.textContent = mensaje;
      elemento.style.display = 'block';
      document.getElementById('mensaje-exito').style.display = 'none';
      window.scrollTo({ top: 0, behavior: 'smooth' });
      setTimeout(() => {
        elemento.style.display = 'none';
      }, 5000);
    }

    // Funciones para cargar datos
    async function cargarVendedores() {
      try {
        const { data, error } = await supabase
          .from('vendedores')
          .select('id, nombre')
          .order('nombre', { ascending: true });

        if (error) {
          console.error('❌ Error al obtener vendedores:', error.message);
          mostrarMensajeError('Error al cargar vendedores');
          return;
        }

        vendedoresData = data;
        mostrarOpcionesVendedores(vendedoresData);
      } catch (err) {
        console.error('❌ Error de conexión:', err);
        mostrarMensajeError('Error de conexión al cargar vendedores');
      }
    }

    async function cargarZonasEntrega() {
      try {
        const { data, error } = await supabase
          .from('zona_entrega')
          .select('id, nombre')
          .order('nombre', { ascending: true });

        if (error) {
          console.error('❌ Error al obtener zonas de entrega:', error.message);
          mostrarMensajeError('Error al cargar zonas de entrega');
          return;
        }

        zonasEntregaData = data;
        mostrarOpcionesZonasEntrega(data);
      } catch (err) {
        console.error('❌ Error de conexión:', err);
        mostrarMensajeError('Error de conexión al cargar zonas de entrega');
      }
    }

    async function cargarProductos() {
      try {
        const { data, error } = await supabase
          .from('productos')
          .select('id, nombre, precio, categoria')
          .order('nombre', { ascending: true });

        if (error) {
          console.error('❌ Error al obtener productos:', error.message);
          mostrarMensajeError('Error al cargar productos');
          return;
        }

        productosData = data;
        mostrarOpcionesProductos(productosData);
      } catch (err) {
        console.error('❌ Error de conexión:', err);
        mostrarMensajeError('Error de conexión al cargar productos');
      }
    }

    // Funciones para mostrar opciones en selects
    function mostrarOpcionesVendedores(vendedores) {
      const select = document.getElementById('vendedor');
      select.innerHTML = '<option disabled selected>Selecciona un vendedor</option>';
      vendedores.forEach(vendedor => {
        const option = document.createElement('option');
        option.value = vendedor.id;
        option.textContent = vendedor.nombre;
        select.appendChild(option);
      });
    }

    function mostrarOpcionesZonasEntrega(zonas) {
      const select = document.getElementById('zona-entrega');
      select.innerHTML = '<option disabled selected>Selecciona una zona de entrega</option>';
      zonas.forEach(zona => {
        const option = document.createElement('option');
        option.value = zona.id;
        option.textContent = zona.nombre;
        select.appendChild(option);
      });
    }

    function mostrarOpcionesProductos(productos) {
      const select = document.getElementById('producto');
      select.innerHTML = '<option disabled selected>Selecciona un producto</option>';
      productos.forEach(producto => {
        const option = document.createElement('option');
        option.value = producto.id;
        option.textContent = `${producto.nombre} - ${producto.categoria} ($${producto.precio})`;
        select.appendChild(option);
      });
    }

    function mostrarOpcionesClientes(clientes) {
      clientesMostrados = clientes;
      const select = document.getElementById('cliente');
      select.innerHTML = '<option disabled selected>Selecciona un cliente</option>';
      clientes.forEach(cliente => {
        const option = document.createElement('option');
        option.value = cliente.id;
        option.textContent = cliente.nombre;
        select.appendChild(option);
      });
    }

    // Función para buscar clientes
    async function buscarClientesRemoto(texto) {
      if (!texto) {
        mostrarOpcionesClientes([]);
        document.getElementById('ruta-reparto').textContent = '---';
        return;
      }
      
      try {
        const { data, error } = await supabase
          .from('clientes')
          .select('id, nombre, ruta_reparto')
          .ilike('nombre', `%${texto}%`)
          .order('nombre', { ascending: true })
          .limit(20);

        if (error) {
          console.error('❌ Error al buscar clientes:', error.message);
          mostrarOpcionesClientes([]);
          return;
        }

        mostrarOpcionesClientes(data);

        if (data.length > 0) {
          document.getElementById('cliente').value = data[0].id;
          document.getElementById('ruta-reparto').textContent = data[0].ruta_reparto || '---';
        } else {
          document.getElementById('cliente').value = '';
          document.getElementById('ruta-reparto').textContent = '---';
        }
      } catch (err) {
        console.error('❌ Error de conexión:', err);
        mostrarOpcionesClientes([]);
      }
    }

    // Funciones para calcular montos
    function calcularMontoTotal() {
      const productoId = parseInt(document.getElementById('producto').value);
      const producto = productosData.find(p => p.id === productoId);
      const cantidad = parseFloat(document.getElementById('cantidad').value) || 0;
      const precioCustom = parseFloat(document.getElementById('precio-custom').value);
      
      if (producto && cantidad > 0) {
        const precio = precioCustom || producto.precio;
        const monto = cantidad * precio;
        document.getElementById('monto-total').textContent = `$${monto.toFixed(2)}`;
      } else {
        document.getElementById('monto-total').textContent = '$0.00';
      }
    }

    function calcularMontoTotalPedido() {
      const total = productosEnPedido.reduce((sum, item) => sum + item.monto, 0);
      document.getElementById('monto-pedido-total').textContent = `$${total.toFixed(2)}`;
    }

    // Funciones para manejo de productos
    function agregarProducto() {
      const productoId = parseInt(document.getElementById('producto').value);
      const cantidad = parseFloat(document.getElementById('cantidad').value);
      const precioCustom = parseFloat(document.getElementById('precio-custom').value);

      if (!productoId) {
        alert('Por favor selecciona un producto');
        return;
      }
      if (!cantidad || cantidad <= 0) {
        alert('Por favor ingresa una cantidad válida');
        return;
      }

      const producto = productosData.find(p => p.id === productoId);
      const precio = precioCustom || producto.precio;
      const monto = cantidad * precio;

      const productoExistente = productosEnPedido.find(p => p.productoId === productoId && p.precio === precio);
      
      if (productoExistente) {
        productoExistente.cantidad += cantidad;
        productoExistente.monto = productoExistente.cantidad * productoExistente.precio;
      } else {
        productosEnPedido.push({
          productoId: productoId,
          nombre: producto.nombre,
          categoria: producto.categoria,
          cantidad: cantidad,
          precio: precio,
          monto: monto
        });
      }

      mostrarTablaProductos();
      calcularMontoTotalPedido();
      limpiarCamposProducto();
    }

    function mostrarTablaProductos() {
      const tbody = document.getElementById('tbody-productos');
      
      if (productosEnPedido.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" class="sin-productos">No hay productos agregados</td></tr>';
        return;
      }

      let html = '';
      productosEnPedido.forEach((item, index) => {
        html += `
          <tr>
            <td class="cantidad">${item.cantidad}</td>
            <td><strong>${item.nombre}</strong><br><small>${item.categoria}</small></td>
            <td class="precio">$${item.precio.toFixed(2)}</td>
            <td class="monto">$${item.monto.toFixed(2)}</td>
            <td class="acciones">
              <button class="btn-eliminar" onclick="app.eliminarProducto(${index})">Eliminar</button>
            </td>
          </tr>
        `;
      });
      
      tbody.innerHTML = html;
    }

    function limpiarCamposProducto() {
      document.getElementById('buscador-producto').value = '';
      document.getElementById('producto').value = '';
      document.getElementById('cantidad').value = '';
      document.getElementById('precio-custom').value = '';
      document.getElementById('precio-producto').textContent = '$0.00';
      document.getElementById('monto-total').textContent = '$0.00';
    }

    // Función para previsualizar pedido
    function previsualizarPedido() {
      const vendedorId = parseInt(document.getElementById('vendedor').value);
      const clienteId = parseInt(document.getElementById('cliente').value);
      const zonaEntregaId = parseInt(document.getElementById('zona-entrega').value);

      if (!vendedorId || !clienteId || !zonaEntregaId) {
        alert('Por favor completa todos los campos obligatorios (Vendedor, Cliente, Zona de Entrega)');
        return;
      }

      if (productosEnPedido.length === 0) {
        alert('Por favor agrega al menos un producto al pedido');
        return;
      }

      const vendedor = vendedoresData.find(v => v.id === vendedorId);
      const cliente = clientesMostrados.find(c => c.id === clienteId);
      const zonaEntrega = zonasEntregaData.find(z => z.id === zonaEntregaId);
      const otroDestino = document.getElementById('otro-destino').value.trim();
      const oferta = document.getElementById('oferta').value.trim();
      const comentarios = document.getElementById('comentarios').value.trim();

      const total = productosEnPedido.reduce((sum, item) => sum + item.monto, 0);

      let html = `
        <div class="resumen-section">
          <h3>Información General</h3>
          <div class="resumen-field"><strong>Vendedor:</strong> ${vendedor.nombre}</div>
          <div class="resumen-field"><strong>Cliente:</strong> ${cliente.nombre}</div>
          <div class="resumen-field"><strong>Ruta:</strong> ${cliente.ruta_reparto || '---'}</div>
          <div class="resumen-field"><strong>Zona de Entrega:</strong> ${zonaEntrega.nombre}</div>
          ${otroDestino ? `<div class="resumen-field"><strong>Otro Destino:</strong> ${otroDestino}</div>` : ''}
          ${oferta ? `<div class="resumen-field"><strong>Oferta:</strong> ${oferta}</div>` : ''}
          ${comentarios ? `<div class="resumen-field"><strong>Comentarios:</strong> ${comentarios}</div>` : ''}
        </div>

        <div class="resumen-section">
          <h3>Productos</h3>
          <table class="tabla-productos" style="margin: 0;">
            <thead>
              <tr>
                <th class="cantidad">Cantidad</th>
                <th>Producto</th>
                <th class="precio">Precio</th>
                <th class="monto">Monto</th>
              </tr>
            </thead>
            <tbody>
      `;

      productosEnPedido.forEach(item => {
        html += `
          <tr>
            <td class="cantidad">${item.cantidad}</td>
            <td><strong>${item.nombre}</strong><br><small>${item.categoria}</small></td>
            <td class="precio">$${item.precio.toFixed(2)}</td>
            <td class="monto">$${item.monto.toFixed(2)}</td>
          </tr>
        `;
      });

      html += `
            </tbody>
          </table>
        </div>
        <div class="total-final">TOTAL: $${total.toFixed(2)}</div>
      `;

      document.getElementById('contenido-preview').innerHTML = html;
      document.getElementById('modal-preview').style.display = 'block';
    }

    // Función para enviar pedido
    async function enviarPedido() {
      const vendedorId = parseInt(document.getElementById('vendedor').value);
      const clienteId = parseInt(document.getElementById('cliente').value);
      const zonaEntregaId = parseInt(document.getElementById('zona-entrega').value);
      const otroDestino = document.getElementById('otro-destino').value.trim();
      const oferta = document.getElementById('oferta').value.trim();
      const comentarios = document.getElementById('comentarios').value.trim();

      try {
        // Crear múltiples registros en la tabla pedidos (uno por producto)
        const pedidosParaInsertar = productosEnPedido.map(item => ({
          cliente_id: clienteId,
          vendedor_id: vendedorId,
          producto_id: item.productoId,
          zona_entrega_id: zonaEntregaId,
          cantidad: item.cantidad,
          precio: item.precio,
          monto: item.monto,
          fecha: new Date().toISOString(),
          otro_destino: otroDestino || null,
          oferta: oferta || null,
          comentarios: comentarios || null
        }));

        const { data, error } = await supabase
          .from('pedidos')
          .insert(pedidosParaInsertar);

        if (error) {
          console.error('❌ Error al enviar pedido:', error.message);
          mostrarMensajeError('Error al enviar el pedido: ' + error.message);
          return;
        }

        // Limpiar formulario